<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>莲塘社康中医体质辨识</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* 全局样式 */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --neutral-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --shadow-light: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.12);
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "SimHei", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--neutral-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1500px;
            width: 100%;
            margin: 0 auto;
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-lg);
            flex: 1;
        }

        header {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin: var(--spacing-md);
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: 28px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        main, aside {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            padding: var(--spacing-xl);
        }

        /* 主内容区滚动容器 */
        .main-content {
            overflow-y: auto;
            max-height: calc(100vh - 220px); /* 减去头部和底部空间 */
            padding-right: var(--spacing-sm); /* 为滚动条预留空间 */
        }

        /* 侧边栏内容区 */
        .sidebar-wrapper {
            position: sticky;
            top: 20px; /* 距离顶部的距离 */
            max-height: calc(100vh - 40px); /* 减去上下边距 */
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .constitution-rules {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            overflow-y: auto;
            padding-right: var(--spacing-sm);
            max-height: 40%;
        }

        footer {
            text-align: center;
            padding: var(--spacing-md) 0;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: auto;
        }

        /* 通用组件样式 */
        .section-title {
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
        }

        /* 中医四诊信息样式 - 关键修复 */
        .diagnosis-container {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin: 0 var(--spacing-md) var(--spacing-lg);
            padding: var(--spacing-lg);
            transition: box-shadow 0.3s ease;
        }
        
        .diagnosis-form {
            margin-bottom: 0;
        }

        /* 四诊信息布局 - 修复核心 */
        .diagnosis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px 20px; /* 合理间距 */
        }

        /* 四诊信息的表单组 - 确保标签在输入框前且间距近 */
        .diagnosis-grid .form-group {
            display: flex;
            align-items: center; /* 垂直居中对齐 */
            gap: 10px; /* 标签与输入框的距离近一些 */
            margin-bottom: 0;
            width: 100%;
        }

        /* 标签样式 - 确保可见 */
        .diagnosis-grid .form-group label {
            width: auto;
            min-width: 50px; /* 确保标签文字不被截断 */
            font-weight: 600;
            color: var(--text-primary);
            padding-top: 0;
            flex-shrink: 0; /* 防止标签被压缩消失 */
            text-align: right; /* 对齐更美观 */
        }

        /* 输入框容器 - 确保不挤压标签 */
        .diagnosis-grid .multi-select-container {
            flex: 1;
            min-width: 0; /* 允许适当收缩 */
        }

        /* 可编辑下拉框样式 */
        .editable-select {
            position: relative;
            flex: 1;
        }
        
        .editable-select input {
            width: 100%; /* 输入框宽度适中 */
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .editable-select input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* 多选下拉框样式 */
        .multi-select-container {
            position: relative;
            flex: 1;
        }
        
        .multi-select-input {
            width: 100%; /* 输入框宽度适中 */
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            transition: border-color 0.3s ease;
        }
        
        .multi-select-input::placeholder {
            font-size: 12px;
            color: #999;
        }
        
        .multi-select-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .multi-select-dropdown.active {
            display: block;
        }
        
        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .multi-select-option:hover {
            background-color: var(--neutral-color);
        }
        
        .multi-select-option.selected {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        /* 下拉框箭头 */
        .select-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-secondary);
            display: none;
        }
        
        .multi-select-container:hover .select-arrow,
        .multi-select-input:focus + .select-arrow {
            display: block;
        }
        
        .select-hint {
            display: none;
        }

        /* BMI计算器样式 */
        .bmi-calculator {
            margin-bottom: var(--spacing-xl);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .form-group label {
            width: 110px;
            font-weight: 600;
            color: var(--text-primary);
            padding-top: 10px;
        }

        .form-group select,
        .form-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .unit {
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .bmi-result {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .bmi-result p {
            margin: 5px 0;
            font-size: 16px;
        }

        #bmiValue {
            font-weight: bold;
            color: var(--primary-color);
        }

        .underweight { color: var(--info-color); font-weight: bold; }
        .normal { color: var(--success-color); font-weight: bold; }
        .overweight { color: var(--warning-color); font-weight: bold; }
        .obese { color: var(--danger-color); font-weight: bold; }

        .bmi-standard {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .bmi-standard h3 {
            margin-bottom: var(--spacing-sm);
            font-size: 16px;
            color: var(--text-primary);
        }

        .bmi-standard ul {
            padding-left: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 问卷样式 */
        .questions-section {
            margin-bottom: var(--spacing-xl);
        }

        .instructions {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
            font-style: italic;
            padding: var(--spacing-md);
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .question-item {
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .question-header h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .related-constitutions {
            font-size: 13px;
            color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .question-text {
            margin-bottom: var(--spacing-md);
            line-height: 1.8;
            color: var(--text-primary);
        }

        /* 选项横向排列 */
        .question-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .option-item:hover {
            background-color: #f0f0f5;
            border-color: #e0e0eb;
        }

        .option-item input {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .option-item label {
            cursor: pointer;
            font-size: 14px;
        }

        /* 提交按钮和文件名区域 */
        .submit-section {
            text-align: center;
            margin: var(--spacing-xl) 0 var(--spacing-md);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .filename-group {
            margin-bottom: var(--spacing-lg);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .filename-group label {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .filename-group input {
            width: 300px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .filename-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .file-extension {
            color: var(--text-secondary);
            font-style: italic;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        #submitBtn, #resetBtn, #calculateBmiBtn {
            margin: 0 8px;
        }

        /* 侧边栏规则说明 */
        .constitution-rules h2 {
            font-size: 18px;
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .constitution-rules ul {
            padding-left: 20px;
            margin-bottom: 0;
            color: var(--text-secondary);
        }

        .constitution-rules li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .constitution-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .constitution-item {
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-secondary);
        }

        .constitution-item strong {
            color: var(--text-primary);
        }

        /* 结果区域 - 固定位置 */
        .results-section {
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            max-height: 60%;
        }

        .results-section h2 {
            margin-bottom: var(--spacing-md);
            font-size: 18px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-table-container {
            max-height: 200px; /* 表格高度限制 */
            overflow-y: auto;
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            min-height: 100%;
        }

        .result-table th, .result-table td {
            border-bottom: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: center;
            font-size: 14px;
        }

        .result-table th {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .summary {
            background-color: rgba(52, 152, 219, 0.1);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.6;
            border-left: 3px solid var(--primary-color);
            flex-shrink: 0;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
            
            .sidebar-wrapper {
                position: static;
                max-height: none;
            }
            
            .constitution-rules, .results-section {
                max-height: none;
            }
            
            .main-content {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .diagnosis-grid {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .related-constitutions {
                align-self: flex-start;
            }
            
            /* 小屏幕下选项恢复垂直排列 */
            .question-options {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .filename-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filename-group input {
                width: 100%;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                width: 100%;
                margin-bottom: 5px;
                padding-top: 0;
            }
            
            #submitBtn, #resetBtn {
                width: 100%;
                margin: 5px 0;
            }
            
            main, aside {
                padding: var(--spacing-md);
            }
            
            .result-table-container {
                max-height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header>
            <h1>莲塘社康中医体质辨识</h1>
            <p>通过专业问卷评估您的体质类型，提供个性化健康参考建议</p>
        </header>
        
        <div class="container">
            <main>
                <!-- 中医四诊信息区域 - 冻结窗口效果 -->
                <div class="diagnosis-container">
                    <section class="diagnosis-form card">
                        <h2 class="section-title">
                            <i class="fa fa-stethoscope" aria-hidden="true"></i> 中医四诊信息
                        </h2>
                        
                        <div class="diagnosis-grid">
                            <!-- 望 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wang">望:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wang" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wang-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">面色红润</div>
                                        <div class="multi-select-option">面色暗黄</div>
                                        <div class="multi-select-option">面色苍白</div>
                                        <div class="multi-select-option">面垢油光</div>
                                        <div class="multi-select-option">面色潮红</div>
                                        <div class="multi-select-option">形体正常</div>
                                        <div class="multi-select-option">形体肥胖</div>
                                        <div class="multi-select-option">形体消瘦</div>
                                        <div class="multi-select-option">疲倦</div>
                                        <div class="multi-select-option">周身困重</div>
                                        <div class="multi-select-option">情绪低沉</div>
                                        <div class="multi-select-option">精力充沛</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 舌 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="she">舌:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="she" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="she-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">舌淡红</div>
                                        <div class="multi-select-option">舌红绛</div>
                                        <div class="multi-select-option">舌暗红</div>
                                        <div class="multi-select-option">舌淡白</div>
                                        <div class="multi-select-option">舌胖，边有齿痕</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 苔 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="tai">苔:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="tai" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="tai-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">苔薄白</div>
                                        <div class="multi-select-option">少苔</div>
                                        <div class="multi-select-option">苔白腻</div>
                                        <div class="multi-select-option">苔黄腻</div>
                                        <div class="multi-select-option">苔燥</div>
                                        <div class="multi-select-option">腐苔</div>
                                        <div class="multi-select-option">剥落苔</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 闻 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wen">闻:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wen" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wen-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">声音低微</div>
                                        <div class="multi-select-option">声音轻浅</div>
                                        <div class="multi-select-option">声音洪亮</div>
                                        <div class="multi-select-option">体味汗味大</div>
                                        <div class="multi-select-option">口有异味</div>
                                        <div class="multi-select-option">无故叹气</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 问 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wen2">问:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wen2" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wen2-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">胃口好</div>
                                        <div class="multi-select-option">胃口差</div>
                                        <div class="multi-select-option">睡眠好</div>
                                        <div class="multi-select-option">睡眠差</div>
                                        <div class="multi-select-option">二便正常</div>
                                        <div class="multi-select-option">大便干结</div>
                                        <div class="multi-select-option">大便溏</div>
                                        <div class="multi-select-option">畏寒怕冷</div>
                                        <div class="multi-select-option">畏热喜凉</div>
                                        <div class="multi-select-option">焦虑不安</div>
                                        <div class="multi-select-option">乏力</div>
                                        <div class="multi-select-option">出汗多</div>
                                        <div class="multi-select-option">口干</div>
                                        <div class="multi-select-option">口苦</div>
                                        <div class="multi-select-option">胸闷</div>
                                        <div class="multi-select-option">痰多</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 切 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="qie">切:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="qie" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="qie-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">脉沉</div>
                                        <div class="multi-select-option">脉浮</div>
                                        <div class="multi-select-option">脉细</div>
                                        <div class="multi-select-option">脉数</div>
                                        <div class="multi-select-option">脉滑</div>
                                        <div class="multi-select-option">脉弦</div>
                                        <div class="multi-select-option">脉弱</div>
                                        <div class="multi-select-option">脉洪大</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <div class="main-content">
                    <form id="quizForm">
                        <!-- BMI计算区域 -->
                        <section class="bmi-calculator card">
                            <h2 class="section-title">
                                <i class="fa fa-calculator" aria-hidden="true"></i> 身体质量指数(BMI)计算
                            </h2>
                            
                            <div class="form-group">
                                <label for="height">身高(厘米):</label>
                                <input type="number" step="0.1" id="height" name="height" placeholder="请输入身高">
                                <span class="unit">cm</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="weight">体重(千克):</label>
                                <input type="number" step="0.1" id="weight" name="weight" placeholder="请输入体重">
                                <span class="unit">kg</span>
                            </div>
                            
                            <button type="button" id="calculateBmiBtn" class="btn">
                                <i class="fa fa-calculator" aria-hidden="true"></i> 计算BMI
                            </button>
                            
                            <div class="bmi-result">
                                <p>BMI指数: <span id="bmiValue">未计算</span></p>
                                <p>体型判断: <span id="bmiCategory"></span></p>
                            </div>
                            
                            <div class="bmi-standard">
                                <h3>BMI判断标准</h3>
                                <ul>
                                    <li>偏瘦: < 18.5</li>
                                    <li>正常: 18.5 - 23.9</li>
                                    <li>超重: 24.0 - 27.9</li>
                                    <li>肥胖: ≥ 28.0</li>
                                </ul>
                            </div>
                        </section>
                        
                        <!-- 问卷区域 -->
                        <section class="questions-section card">
                            <h2 class="section-title">
                                <i class="fa fa-list-alt" aria-hidden="true"></i> 体质辨识问卷
                            </h2>
                            
                            <p class="instructions">
                                请根据您的实际情况选择最符合的选项，这将帮助我们更准确地判断您的体质类型。
                                所有问题没有对错之分，请如实选择即可。
                            </p>
                            
                            <div class="questions-container" id="questionsContainer">
                                <!-- 问题将通过JavaScript动态生成 -->
                            </div>
                        </section>
                        
                        <!-- 按钮区域 -->
                        <div class="submit-section">
                            <div class="filename-group">
                                <label for="filename">保存文件名:</label>
                                <input type="text" id="filename" placeholder="请输入文件名">
                                <span class="file-extension">.xlsx</span>
                            </div>
                            
                            <button type="button" id="resetBtn" class="btn btn-secondary">
                                <i class="fa fa-refresh" aria-hidden="true"></i> 重置
                            </button>
                            
                            <button type="button" id="submitBtn" class="btn">
                                <i class="fa fa-download" aria-hidden="true"></i> 下载结果
                            </button>
                        </div>
                    </form>
                </div>
            </main>
            
            <!-- 体质判断规则和实时结果（固定位置） -->
            <aside>
                <div class="sidebar-wrapper">
                    <div class="constitution-rules">
                        <div>
                            <h2>
                                <i class="fa fa-book" aria-hidden="true"></i> 体质判断规则
                            </h2>
                            <ul>
                                <li>平和质：根据选项直接得分，最高25分</li>
                                <li>其他体质：≥11分为确定，9-10分为偏向</li>
                                <li>若其他体质≥11分则否定平和质</li>
                                <li>平和质≥18分为确定，16-17分为偏向</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h2>
                                <i class="fa fa-link" aria-hidden="true"></i> 体质关联题目
                            </h2>
                            <div class="constitution-questions" id="constitutionQuestions">
                                <!-- 将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-section">
                        <h2>
                            <i class="fa fa-bar-chart" aria-hidden="true"></i> 实时体质结果
                        </h2>
                        
                        <div class="result-table-container">
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <th>体质类型</th>
                                        <th>得分</th>
                                        <th>结果</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- 将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="summary" id="resultSummary">
                            请开始作答以查看结果
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <footer>
            <p>中医体质辨识工具 &copy; 2023 | 仅供健康参考，不替代专业医疗建议</p>
        </footer>
    </div>

    <script>
        // 初始化多选下拉框功能
        function initMultiSelects() {
            // 为每个四诊项目初始化多选功能
            const fields = ['wang', 'she', 'tai', 'wen', 'wen2', 'qie'];
            const allDropdowns = fields.map(field => document.getElementById(`${field}-dropdown`));
            
            fields.forEach(field => {
                const input = document.getElementById(field);
                const dropdown = document.getElementById(`${field}-dropdown`);
                const options = dropdown.querySelectorAll('.multi-select-option');
                const selectedValues = new Set();
                
                // 点击输入框显示/隐藏下拉框
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 关闭所有其他下拉框
                    allDropdowns.forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                        }
                    });
                    
                    // 切换当前下拉框状态
                    dropdown.classList.toggle('active');
                });
                
                // 点击选项选择/取消选择
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const value = option.textContent;
                        
                        if (selectedValues.has(value)) {
                            // 取消选择
                            selectedValues.delete(value);
                            option.classList.remove('selected');
                        } else {
                            // 选择
                            selectedValues.add(value);
                            option.classList.add('selected');
                        }
                        
                        // 更新输入框显示
                        input.value = Array.from(selectedValues).join(', ');
                        updateResults();
                    });
                });
                
                // 点击其他地方关闭下拉框
                document.addEventListener('click', () => {
                    dropdown.classList.remove('active');
                });
                
                // 阻止下拉框内部点击事件冒泡
                dropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // 监听手动输入
                input.addEventListener('change', () => {
                    // 清空选择状态
                    selectedValues.clear();
                    options.forEach(option => option.classList.remove('selected'));
                    
                    // 解析手动输入的值
                    if (input.value.trim()) {
                        const values = input.value.split(',').map(v => v.trim());
                        values.forEach(value => {
                            selectedValues.add(value);
                            // 标记匹配的选项
                            options.forEach(option => {
                                if (option.textContent === value) {
                                    option.classList.add('selected');
                                }
                            });
                        });
                    }
                    updateResults();
                });
            });
        }

        // 问卷题目数据
        const questionsData = [
            {
                "id": 1,
                "text": "您精力充沛么吗？（指精神头足，乐于做事）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 2,
                "text": "您容易疲乏吗？（指体力如何，是否稍微活动一下或做一点家务劳动就感到累）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 3,
                "text": "您容易气短，呼吸短促，接不上气吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 4,
                "text": "您说话声音低弱无力吗？（指说话没有力气）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 5,
                "text": "您感到闷闷不乐，情绪低沉吗？（指心情不愉快，情绪低落）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 6,
                "text": "您容易精神紧张，焦虑不安吗？（指遇事是否心情紧张）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 7,
                "text": "您因为生活状态改变而感到孤独、失落吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 8,
                "text": "您容易感到害怕或受到惊吓吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 9,
                "text": "您感到身体超重不轻松吗？（感觉身体沉重）[BMI指数＝体重（kg）/身高²（m）]",
                "options": ["BMI<24", "24≤BMI<25", "25≤BMI<26", "26≤BMI<28", "BMI≥28"]
            },
            {
                "id": 10,
                "text": "您眼睛干涩吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 11,
                "text": "您手脚发凉吗？（不包含因周围温度低或穿的少导致的手脚发冷）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 12,
                "text": "您胃脘部、背部或腰膝部怕冷吗？（指上腹部、背部、腰部或膝关节等，有一处或多处怕冷）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 13,
                "text": "您比一般人耐受不了寒冷吗？（指比别人容易害怕冬天或是夏天的冷空调，电扇等）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 14,
                "text": "您容易患感冒吗？（指每年感冒的次数）",
                "options": ["一年<2次", "一年感冒2－4次", "一年感冒5－6次", "一年感冒8次以上", "几乎每月都感冒"]
            },
            {
                "id": 15,
                "text": "您没有感冒时也会鼻塞、流鼻涕吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 16,
                "text": "您有口粘口腻，或睡眠打鼾吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 17,
                "text": "您容易过敏(对药物、食物、气味、花粉或在季节交替、气候变化时)吗?",
                "options": ["从来没有", "一年1、2次", "一年3、4次", "一年5、6次", "每次遇到上述原因都过敏"]
            },
            {
                "id": 18,
                "text": "您的皮肤容易起荨麻疹吗? (包括风团、风疹块、风疙瘩)",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 19,
                "text": "您的皮肤在不知不觉中会出现青紫瘀斑、皮下出血吗?（指皮肤在没有外伤的情况下出现青一块紫一块的情况）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 20,
                "text": "您的皮肤一抓就红，并出现抓痕吗?（指被指甲或钝物划过后皮肤的反应）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 21,
                "text": "您皮肤或口唇干吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 22,
                "text": "您有肢体麻木或固定部位疼痛的感觉吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 23,
                "text": "您面部或鼻部有油腻感或者油亮发光吗?（指脸上或鼻子）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 24,
                "text": "您面色或目眶晦黯，或出现褐色斑块/斑点吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 25,
                "text": "您有皮肤湿疹、疮疖吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 26,
                "text": "您感到口干咽燥、总想喝水吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 27,
                "text": "您感到口苦或嘴里有异味吗?（指口苦或口臭）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 28,
                "text": "您腹部肥大吗?（指腹部脂肪肥厚）",
                "options": ["腹围<80cm,相当于2.4尺", "腹围80-85cm,2.4-2.55尺", "腹围86-90cm,2.56-2.7尺", "腹围91-105cm,2.71-3.15尺", "腹围>105cm或3.15尺"]
            },
            {
                "id": 29,
                "text": "您吃(喝)凉的东西会感到不舒服或者怕吃(喝)凉的东西吗？（指不喜欢吃凉的食物，或吃了凉的食物后会不舒服）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 30,
                "text": "您有大便黏滞不爽、解不尽的感觉吗?(大便容易粘在马桶或便坑壁上)",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 31,
                "text": "您容易大便干燥吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 32,
                "text": "您舌苔厚腻或有舌苔厚厚的感觉吗?（如果自我感觉不清楚可由调查员观察后填写）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 33,
                "text": "您舌下静脉瘀紫或增粗吗？（可由调查员辅助观察后填写）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            }
        ];

        // 定义体质与关联题目
        const constitutionQuestions = {
            "阳虚质": [11, 12, 13, 29],
            "阴虚质": [10, 21, 26, 31],
            "气虚质": [2, 3, 4, 14],
            "痰湿质": [9, 16, 28, 32],
            "湿热质": [23, 25, 27, 30],
            "血瘀质": [19, 22, 24, 33],
            "特禀质": [15, 17, 18, 20],
            "气郁质": [5, 6, 7, 8],
            "平和质": [1, 2, 4, 5, 13]
        };

        // 其他体质计分规则
        const optionScores = {
            "没有": 1,
            "很少": 2,
            "有时": 3,
            "经常": 4,
            "总是": 5,
            "一年<2次": 1,
            "一年感冒2－4次": 2,
            "一年感冒5－6次": 3,
            "一年感冒8次以上": 4,
            "几乎每月都感冒": 5,
            "从来没有": 1,
            "一年1、2次": 2,
            "一年3、4次": 3,
            "一年5、6次": 4,
            "每次遇到上述原因都过敏": 5,
            "BMI<24": 1,
            "24≤BMI<25": 2,
            "25≤BMI<26": 3,
            "26≤BMI<28": 4,
            "BMI≥28": 5,
            "腹围<80cm,相当于2.4尺": 1,
            "腹围80-85cm,2.4-2.55尺": 2,
            "腹围86-90cm,2.56-2.7尺": 3,
            "腹围91-105cm,2.71-3.15尺": 4,
            "腹围>105cm或3.15尺": 5
        };

        // 特殊题目ID（有特殊选项的题目）
        const specialQuestionIds = new Set([9, 14, 17, 28]);

        // 平和质特殊计分规则
        const pingheScoring = {
            1: {"没有": 1, "很少": 2, "有时": 3, "经常": 4, "总是": 5},
            2: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            4: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            5: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            13: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1}
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化多选下拉框
            initMultiSelects();
            
            // 设置默认文件名（包含当前日期时间）
            setDefaultFilename();
            
            // 生成体质关联题目列表
            generateConstitutionQuestionsList();
            
            // 生成问卷题目
            generateQuestions();
            
            // 绑定事件处理函数
            bindEvents();
            
            // 初始化结果表格
            updateResults();
        });

        // 设置默认文件名
        function setDefaultFilename() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const defaultFilename = `体质辨识结果_${year}${month}${day}_${hours}${minutes}${seconds}`;
            document.getElementById('filename').value = defaultFilename;
        }

        // 生成体质关联题目列表
        function generateConstitutionQuestionsList() {
            const container = document.getElementById('constitutionQuestions');
            container.innerHTML = '';
            
            for (const [constitution, qIds] of Object.entries(constitutionQuestions)) {
                const div = document.createElement('div');
                div.className = 'constitution-item';
                div.innerHTML = `<strong>${constitution}:</strong> ${qIds.join(', ')}`;
                container.appendChild(div);
            }
        }

        // 生成问卷题目
        function generateQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            // 按ID排序问题
            const sortedQuestions = [...questionsData].sort((a, b) => a.id - b.id);
            
            sortedQuestions.forEach(question => {
                // 找到关联的体质类型
                const relatedConstitutions = [];
                for (const [constitution, qIds] of Object.entries(constitutionQuestions)) {
                    if (qIds.includes(question.id)) {
                        relatedConstitutions.push(constitution);
                    }
                }
                
                // 创建问题容器
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.dataset.id = question.id;
                
                // 问题头部（包含ID和关联体质）
                let headerHtml = `<div class="question-header">
                    <h3>问题 ${question.id}</h3>`;
                
                if (relatedConstitutions.length > 0) {
                    headerHtml += `<div class="related-constitutions">
                        关联体质: ${relatedConstitutions.join(', ')}
                    </div>`;
                }
                
                headerHtml += `</div>`;
                
                // 问题文本
                headerHtml += `<div class="question-text">${question.text}</div>`;
                
                // 选项（横向排列）
                headerHtml += `<div class="question-options">`;
                
                question.options.forEach((option, index) => {
                    headerHtml += `
                        <div class="option-item">
                            <input type="radio" name="q${question.id}" 
                                   id="q${question.id}-${index}" 
                                   value="${option}" 
                                   ${index === 0 ? 'checked' : ''}>
                            <label for="q${question.id}-${index}">${option}</label>
                        </div>
                    `;
                });
                
                headerHtml += `</div>`;
                
                questionDiv.innerHTML = headerHtml;
                container.appendChild(questionDiv);
            });
        }

        // 绑定事件处理函数
        function bindEvents() {
            // BMI计算按钮
            document.getElementById('calculateBmiBtn').addEventListener('click', calculateBMI);
            
            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            // 提交按钮
            document.getElementById('submitBtn').addEventListener('click', downloadResults);
            
            // 所有单选按钮变化时更新结果
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', updateResults);
            });
            
            // 回车键计算BMI
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && 
                    (document.activeElement === document.getElementById('height') || 
                     document.activeElement === document.getElementById('weight'))) {
                    calculateBMI();
                }
            });
        }

        // 计算BMI
        function calculateBMI() {
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const bmiValue = document.getElementById('bmiValue');
            const bmiCategory = document.getElementById('bmiCategory');
            
            try {
                const height = parseFloat(heightInput.value);
                const weight = parseFloat(weightInput.value);
                
                if (isNaN(height) || isNaN(weight) || height <= 0 || weight <= 0) {
                    alert('请输入有效的身高和体重数值');
                    return;
                }
                
                const heightM = height / 100;
                const bmi = weight / (heightM * heightM);
                bmiValue.textContent = bmi.toFixed(1);
                
                // 设置BMI分类和样式
                if (bmi < 18.5) {
                    bmiCategory.textContent = "偏瘦";
                    bmiCategory.className = "underweight";
                } else if (bmi < 24) {
                    bmiCategory.textContent = "正常";
                    bmiCategory.className = "normal";
                } else if (bmi < 28) {
                    bmiCategory.textContent = "超重";
                    bmiCategory.className = "overweight";
                } else {
                    bmiCategory.textContent = "肥胖";
                    bmiCategory.className = "obese";
                }
                
                // 更新结果
                updateResults();
            } catch (error) {
                alert('计算BMI时出错: ' + error.message);
            }
        }

        // 重置表单
        function resetForm() {
            if (confirm('确定要重置所有回答和BMI数据吗？')) {
                // 重置四诊信息
                const fields = ['wang', 'she', 'tai', 'wen', 'wen2', 'qie'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    const dropdown = document.getElementById(`${field}-dropdown`);
                    const options = dropdown.querySelectorAll('.multi-select-option');
                    
                    input.value = '';
                    options.forEach(option => option.classList.remove('selected'));
                });
                
                // 重置BMI输入
                document.getElementById('height').value = '';
                document.getElementById('weight').value = '';
                document.getElementById('bmiValue').textContent = '未计算';
                document.getElementById('bmiCategory').textContent = '';
                document.getElementById('bmiCategory').className = '';
                
                // 重置所有单选按钮为第一个选项
                document.querySelectorAll('.question-item').forEach(question => {
                    const radios = question.querySelectorAll('input[type="radio"]');
                    if (radios.length > 0) {
                        radios[0].checked = true;
                    }
                });
                
                // 重置文件名
                setDefaultFilename();
                
                // 更新结果
                updateResults();
            }
        }

        // 获取所有答案
        function getAnswers() {
            const answers = {};
            
            document.querySelectorAll('.question-item').forEach(question => {
                const qId = question.dataset.id;
                const selectedOption = question.querySelector(`input[name="q${qId}"]:checked`);
                
                if (selectedOption) {
                    answers[qId] = selectedOption.value;
                }
            });
            
            return answers;
        }

        // 获取四诊信息
        function getDiagnosisInfo() {
            return {
                "望": document.getElementById('wang').value || '未填写',
                "舌": document.getElementById('she').value || '未填写',
                "苔": document.getElementById('tai').value || '未填写',
                "闻": document.getElementById('wen').value || '未填写',
                "问": document.getElementById('wen2').value || '未填写',
                "切": document.getElementById('qie').value || '未填写'
            };
        }

        // 计算体质得分
        function calculateConstitutionScores(answers) {
            const scores = {};
            // 初始化所有体质得分为0
            Object.keys(constitutionQuestions).forEach(constitution => {
                scores[constitution] = 0;
            });
            
            // 计算每个体质的得分
            for (const [constitution, questionIds] of Object.entries(constitutionQuestions)) {
                if (constitution === "平和质") {
                    // 平和质使用特殊计分规则
                    let pingheTotal = 0;
                    questionIds.forEach(qId => {
                        const answer = answers[qId] || "";
                        if (pingheScoring[qId] && pingheScoring[qId][answer]) {
                            pingheTotal += pingheScoring[qId][answer];
                        } else if (specialQuestionIds.has(Number(qId))) {
                            // 特殊题目计分
                            const question = questionsData.find(q => q.id === Number(qId));
                            if (question && question.options.includes(answer)) {
                                pingheTotal += question.options.indexOf(answer) + 1;
                            }
                        }
                    });
                    scores[constitution] = pingheTotal;
                } else {
                    // 其他体质使用标准计分规则
                    let totalScore = 0;
                    questionIds.forEach(qId => {
                        const answer = answers[qId] || "";
                        if (specialQuestionIds.has(Number(qId))) {
                            // 特殊题目计分
                            const question = questionsData.find(q => q.id === Number(qId));
                            if (question && question.options.includes(answer)) {
                                totalScore += question.options.indexOf(answer) + 1;
                            }
                        } else {
                            totalScore += optionScores[answer] || 0;
                        }
                    });
                    scores[constitution] = totalScore;
                }
            }
            
            return scores;
        }

        // 判断体质类型
        function determineConstitutionTypes(scores) {
            const results = {};
            let otherConstitutionsHigh = false; // 是否有其他体质≥11分
            
            // 先判断非平和质的体质类型
            Object.entries(scores).forEach(([constitution, score]) => {
                if (constitution !== "平和质") {
                    if (score >= 11) {
                        results[constitution] = "确定";
                        otherConstitutionsHigh = true;
                    } else if (score >= 9 && score <= 10) {
                        results[constitution] = "偏向";
                    } else {
                        results[constitution] = "否定";
                    }
                }
            });
            
            // 判断平和质
            if (otherConstitutionsHigh) {
                results["平和质"] = "否定";
            } else {
                const pingheScore = scores["平和质"];
                if (pingheScore >= 18) {
                    results["平和质"] = "确定";
                } else if (pingheScore >= 16 && pingheScore <= 17) {
                    results["平和质"] = "偏向";
                } else {
                    results["平和质"] = "否定";
                }
            }
            
            return results;
        }

        // 更新结果显示
        function updateResults() {
            const answers = getAnswers();
            const scores = calculateConstitutionScores(answers);
            const results = determineConstitutionTypes(scores);
            
            // 更新结果表格
            updateResultsTable(scores, results);
            
            // 更新结果总结
            updateResultSummary(scores, results);
        }

        // 更新结果表格
        function updateResultsTable(scores, results) {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            // 按得分排序
            const sortedConstitutions = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);
            
            sortedConstitutions.forEach(constitution => {
                const row = document.createElement('tr');
                
                // 根据结果设置不同的颜色
                let resultClass = '';
                if (results[constitution] === "确定") {
                    resultClass = 'style="color: var(--success-color); font-weight: bold"';
                } else if (results[constitution] === "偏向") {
                    resultClass = 'style="color: var(--warning-color)"';
                }
                
                row.innerHTML = `
                    <td>${constitution}</td>
                    <td>${scores[constitution]}</td>
                    <td ${resultClass}>${results[constitution]}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 更新结果总结
        function updateResultSummary(scores, results) {
            const summaryElement = document.getElementById('resultSummary');
            
            // 分离确定和偏向的体质
            const definiteConstitutions = [];
            const leaningConstitutions = [];
            
            Object.entries(results).forEach(([constitution, result]) => {
                if (result === "确定") {
                    definiteConstitutions.push(constitution);
                } else if (result === "偏向") {
                    leaningConstitutions.push(constitution);
                }
            });
            
            // 构建总结文本
            const summaryParts = [];
            
            if (definiteConstitutions.length > 0) {
                summaryParts.push(`确定的体质类型: ${definiteConstitutions.join(', ')}`);
            }
            
            if (leaningConstitutions.length > 0) {
                summaryParts.push(`偏向的体质类型: ${leaningConstitutions.join(', ')}`);
            }
            
            // 添加BMI信息
            const bmiValue = document.getElementById('bmiValue').textContent;
            const bmiCategory = document.getElementById('bmiCategory').textContent;
            if (bmiValue !== '未计算' && bmiCategory) {
                summaryParts.push(`BMI指数: ${bmiValue} (${bmiCategory})`);
            }
            
            // 设置总结文本
            if (summaryParts.length === 0) {
                summaryElement.textContent = "未能确定明显的体质类型";
            } else {
                summaryElement.innerHTML = summaryParts.join('<br>');
            }
        }

        // 下载结果为Excel
        function downloadResults() {
            try {
                // 获取用户输入的文件名
                let filename = document.getElementById('filename').value.trim();
                
                // 验证文件名
                if (!filename) {
                    alert('请输入文件名');
                    return;
                }
                
                // 移除可能的文件扩展名（会自动添加.xlsx）
                filename = filename.replace(/\.(xlsx|xls)$/i, '');
                
                // 获取答案和计算结果
                const answers = getAnswers();
                const scores = calculateConstitutionScores(answers);
                const results = determineConstitutionTypes(scores);
                
                // 获取四诊信息
                const diagnosisInfo = getDiagnosisInfo();
                
                // 获取BMI数据
                const bmiData = {
                    height: document.getElementById('height').value || '未填写',
                    weight: document.getElementById('weight').value || '未填写',
                    bmi: document.getElementById('bmiValue').textContent,
                    category: document.getElementById('bmiCategory').textContent || '未计算'
                };
                
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 1. 创建个人信息工作表
                const personalData = [
                    ["信息项", "数值"],
                    ["提交时间", new Date().toLocaleString()],
                    ["身高(cm)", bmiData.height],
                    ["体重(kg)", bmiData.weight],
                    ["BMI指数", bmiData.bmi],
                    ["体型判断", bmiData.category],
                    ["", ""], // 空行分隔
                    ["中医四诊信息", ""],
                    ["望", diagnosisInfo["望"]],
                    ["舌", diagnosisInfo["舌"]],
                    ["苔", diagnosisInfo["苔"]],
                    ["闻", diagnosisInfo["闻"]],
                    ["问", diagnosisInfo["问"]],
                    ["切", diagnosisInfo["切"]]
                ];
                const personalWs = XLSX.utils.aoa_to_sheet(personalData);
                XLSX.utils.book_append_sheet(wb, personalWs, "个人信息");
                
                // 2. 创建问卷答案工作表
                const answersData = [["问题ID", "问题内容", "选择答案", "得分", "关联体质"]];
                
                questionsData.forEach(question => {
                    const qId = question.id;
                    const answer = answers[qId] || "";
                    
                    // 计算得分
                    let score = 0;
                    let scoreNote = "";
                    
                    if (specialQuestionIds.has(qId)) {
                        if (question.options.includes(answer)) {
                            score = question.options.indexOf(answer) + 1;
                            scoreNote = score.toString();
                        }
                    } else {
                        score = optionScores[answer] || 0;
                        scoreNote = score.toString();
                    }
                    
                    // 检查是否是平和质的特殊计分题目
                    if (pingheScoring[qId] && pingheScoring[qId][answer]) {
                        const pingheScore = pingheScoring[qId][answer];
                        scoreNote = `标准分:${score}, 平和质得分:${pingheScore}`;
                    }
                    
                    // 获取关联体质
                    const relatedConstitutions = [];
                    Object.entries(constitutionQuestions).forEach(([constitution, qIds]) => {
                        if (qIds.includes(qId)) {
                            relatedConstitutions.push(constitution);
                        }
                    });
                    
                    answersData.push([
                        qId,
                        question.text,
                        answer,
                        scoreNote,
                        relatedConstitutions.join(', ')
                    ]);
                });
                
                const answersWs = XLSX.utils.aoa_to_sheet(answersData);
                XLSX.utils.book_append_sheet(wb, answersWs, "问卷答案");
                
                // 3. 创建体质辨识结果工作表
                const resultsData = [["体质类型", "得分", "判断结果", "关联题目"]];
                
                Object.entries(results).forEach(([constitution, result]) => {
                    const relatedQuestions = constitutionQuestions[constitution].join(', ');
                    resultsData.push([
                        constitution,
                        scores[constitution],
                        result,
                        relatedQuestions
                    ]);
                });
                
                // 添加体质总结
                resultsData.push([]);
                resultsData.push([]);
                const definiteConstitutions = Object.entries(results)
                    .filter(([_, result]) => result === "确定")
                    .map(([constitution, _]) => constitution);
                
                const leaningConstitutions = Object.entries(results)
                    .filter(([_, result]) => result === "偏向")
                    .map(([constitution, _]) => constitution);
                
                if (definiteConstitutions.length > 0) {
                    resultsData.push(["主要体质类型:", definiteConstitutions.join(', ')]);
                }
                
                if (leaningConstitutions.length > 0) {
                    resultsData.push(["偏向体质类型:", leaningConstitutions.join(', ')]);
                }
                
                const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
                XLSX.utils.book_append_sheet(wb, resultsWs, "体质结果");
                
                // 生成并下载Excel文件
                XLSX.writeFile(wb, `${filename}.xlsx`);
                
                // 显示成功提示
                alert('体质辨识结果已成功导出为Excel文件！');
            } catch (error) {
                console.error('导出Excel失败:', error);
                alert('导出Excel时发生错误: ' + error.message);
            }
        }
    </script>
</body>
</html>
